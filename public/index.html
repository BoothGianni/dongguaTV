<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="no-referrer">
    <title>小灰灰影视</title>

    <script>
        // 兼容性检测
        (function () {
            var missing = [];
            if (typeof Proxy === 'undefined') missing.push('Proxy');
            if (typeof fetch === 'undefined') missing.push('fetch');
            if (typeof Promise === 'undefined') missing.push('Promise');
            if (missing.length > 0) {
                if (window.stop) window.stop();
                document.write('<div style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;background:#000;color:#fff;display:flex;justify-content:center;align-items:center;text-align:center;">内核版本过低，请升级浏览器</div>');
            }
        })();
    </script>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <meta name="theme-color" content="#000000">

    <link href="libs/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="libs/css/fontawesome.min.css">
    <script data-cfasync="false" src="libs/js/vue.global.prod.min.js"></script>
    <script data-cfasync="false" src="libs/js/hls.min.js" defer></script>
    <script data-cfasync="false" src="libs/js/DPlayer.min.js" defer></script>
    <script data-cfasync="false" src="libs/js/bootstrap.bundle.min.js" defer></script>

    <style>
        :root {
            --bg-color: #000000;
            --panel-bg: #1f1f1f;
            --accent: #e50914;
            --text-main: #ffffff;
            --text-sub: #b3b3b3;
            --border: rgba(255, 255, 255, 0.1);
        }

        /* 核心适配：全屏背景和异形屏边距 */
        body {
            background-color: #000000 !important;
            color: var(--text-main);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            min-height: 100vh;
            margin: 0;
            /* 适配挖孔屏，防止画面被状态栏挤压错位 */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            text-rendering: optimizeSpeed;
            -webkit-font-smoothing: antialiased;
        }

        #app { background-color: #000000; }
        [v-cloak] { display: none !important; }

        /* 修复 DPlayer 在手机全屏时的错位 */
        #dplayer {
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }

        .navbar-custom {
            position: fixed;
            top: env(safe-area-inset-top); /* 导航栏避开挖孔 */
            left: 0;
            width: 100%;
            z-index: 1000;
            padding: 15px 4%;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9) 0%, transparent 100%);
        }

        /* 其他原有样式保持不变，此处省略部分非核心 CSS 以节省空间 */
        .poster-wrap { aspect-ratio: 2/3; border-radius: 6px; overflow: hidden; background: #222; position: relative; }
        .movie-name { margin-top: 10px; font-size: 14px; color: #eee; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>

<body>
<div id="app-loader" class="app-loader">
    <div class="loader-logo"><img src="icon.png" style="height: 42px; border-radius: 10px;"> 视界MAX</div>
    <div class="loader-spinner"></div>
</div>

<div id="app" v-cloak>
    <nav class="navbar-custom" v-show="!searched">
        <div class="brand" @click="goHome"><img src="icon.png" style="height: 28px; border-radius: 6px;"> 视界MAX</div>
    </nav>

    <div class="search-section" :style="{ marginTop: searched ? '80px' : '60px' }">
        <div class="search-box-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" v-model="keyword" @keyup.enter="doSearch" class="search-input" placeholder="输入片名搜索...">
        </div>
    </div>

    <div v-if="!searched" style="padding-top: 20px;">
        <div class="section-container" v-for="(config, key) in rowConfigs" :key="key">
            <div class="section-header">
                <div class="section-line"></div>
                <div class="section-title">{{ config.title }}</div>
            </div>
            <div class="hot-row">
                <div class="hot-card" v-for="item in rowLists[key]" :key="item.id" @click="autoSearch(item.title || item.name)">
                    <div class="poster-wrap">
                        <img :src="getPosterUrl(item.poster_path)" loading="lazy">
                    </div>
                    <div class="movie-name">{{ item.title || item.name }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="section-container" v-if="searched">
        <div class="result-grid">
            <div class="result-card" v-for="group in groupedList" :key="group.name" @click="openDetail(group)">
                <div class="poster-wrap"><img :src="group.pic" loading="lazy"></div>
                <div class="movie-name">{{ group.name }}</div>
            </div>
        </div>
    </div>

    <div class="detail-overlay" :class="{ active: showDetail }">
        <div class="close-btn" @click="closeDetail"><i class="fas fa-times"></i></div>
        <div class="player-layout" v-if="currentGroup">
            <h2 class="video-title">{{ currentGroup.name }}</h2>
            <div class="player-box">
                <div id="dplayer"></div>
            </div>
            <div class="source-list">
                <div v-for="ep in episodeList" class="ep-btn" :class="{ active: currentUrl === ep.url }" @click="play(ep.url)">
                    {{ ep.name }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;
    let dp = null;

    createApp({
        data() {
            return {
                keyword: '',
                searched: false,
                rowLists: {},
                rowConfigs: {
                    movieRow: { title: '热门电影', path: '/trending/movie/week' },
                    tvRow: { title: '热门剧集', path: '/trending/tv/week' }
                },
                showDetail: false,
                currentGroup: null,
                episodeList: [],
                currentUrl: '',
                TMDB_IMG_URL: '/api/tmdb-image/w342'
            }
        },
        mounted() {
            this.initApp();
            // 隐藏启动遮罩
            setTimeout(() => { document.getElementById('app-loader').style.display = 'none'; }, 500);
        },
        methods: {
            initApp() {
                Object.keys(this.rowConfigs).forEach(key => {
                    fetch(`/api/tmdb-proxy?path=${encodeURIComponent(this.rowConfigs[key].path)}`)
                        .then(res => res.json())
                        .then(data => { this.rowLists[key] = data.results; });
                });
            },
            getPosterUrl(path) { return path ? this.TMDB_IMG_URL + path : 'icon.png'; },
            autoSearch(name) { this.keyword = name; this.doSearch(); },
            doSearch() {
                this.searched = true;
                fetch(`/api/search?wd=${encodeURIComponent(this.keyword)}`)
                    .then(res => res.json())
                    .then(data => { this.groupedList = data; }); // 简化逻辑
            },
            openDetail(group) {
                this.currentGroup = group;
                this.showDetail = true;
                // 解析选集并播放
                const playUrl = group.sources[0].vod_play_url;
                this.episodeList = playUrl.split('#').map(e => ({ name: e.split('$')[0], url: e.split('$')[1] }));
                this.play(this.episodeList[0].url);
            },
            play(url) {
                this.currentUrl = url;
                if (!dp) {
                    dp = new DPlayer({
                        container: document.getElementById('dplayer'),
                        video: { url: url, type: 'hls' }
                    });

                    // --- 关键补丁：在 DPlayer 初始化后绑定全屏沉浸逻辑 ---
                    dp.on('fullscreen', () => {
                        // 隐藏状态栏
                        if (window.Capacitor && window.Capacitor.Plugins.StatusBar) {
                            window.Capacitor.Plugins.StatusBar.hide();
                        }
                        // 锁定横屏
                        if (screen.orientation && screen.orientation.lock) {
                            screen.orientation.lock('landscape').catch(() => {});
                        }
                    });

                    dp.on('fullscreen_cancel', () => {
                        // 恢复状态栏
                        if (window.Capacitor && window.Capacitor.Plugins.StatusBar) {
                            window.Capacitor.Plugins.StatusBar.show();
                        }
                        if (screen.orientation && screen.orientation.unlock) {
                            screen.orientation.unlock();
                        }
                    });
                } else {
                    dp.switchVideo({ url: url, type: 'hls' });
                }
                dp.play();
            },
            closeDetail() { this.showDetail = false; if(dp) dp.pause(); },
            goHome() { this.searched = false; this.keyword = ''; }
        }
    }).mount('#app');
</script>
</body>
</html>